Enhance database queries for middleware (complex)
